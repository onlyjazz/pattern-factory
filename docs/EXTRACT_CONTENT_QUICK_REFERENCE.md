# Extract Content Flow - Quick Reference\n\n## What Was Built\n\nA complete pipeline for extracting entities from URLs and upserting them into the database.\n\n## The Three New/Modified Agents\n\n### 1. `model.verifyUpsert`\n**File:** `backend/pitboss/agents.py:935-1122`\n\n**What it does:** Validates the extracted entity payload\n\n**Checks:**\n- All required arrays present (orgs, guests, posts, patterns, links)\n- Required fields: orgs/guests/posts have `name`; patterns have `name` + `kind`\n- Link integrity: no orphan references\n- Safety: no SQL injection patterns\n- Semantics: URL/source consistency, valid timestamps\n\n**Returns:**\n- ✅ `(\"yes\", 0.94, \"Payload validation passed: ...\")`\n- ❌ `(\"no\", 0.85-0.95, \"<specific error>\")`\n\n---\n\n### 2. `tool.executeSQL` (dual-flow)\n**File:** `backend/pitboss/agents.py:460-592`\n\n**What it does:** Branches on workflow verb and executes appropriate operation\n\n**CONTENT branch:**\n```python\nif verb == \"CONTENT\":\n    upsert_res = await tool_registry.execute(\n        \"execute_upsert\",\n        jsonb_payload=extracted_entities\n    )\n```\n\n**RULE branch:** (unchanged) Creates materialized view\n\n**Returns:**\n- ✅ `(\"yes\", 0.96, \"Content extraction and upsert complete: <url>\")`\n- ❌ `(\"no\", 0.3, \"Upsert procedure failed: <error>\")`\n\n---\n\n### 3. `model.requestToExtractEntities` (updated)\n**File:** `backend/pitboss/agents.py:763-951`\n\n**What it does:** Extracts entities from URL content using LLM\n\n**Previously:** Returned decision=\"no\" (triggered HITL, showed raw JSON)\n**Now:** Returns decision=\"yes\" (proceeds to verifyUpsert), shows clean summary\n\n**Returns:**\n```\nPost: 'Dissent is an act of faith' (Sep 26, 2025)\nOrganizations: Medable\nGuests: Pamela Tenaerts\nPatterns: Boss is Stuck\n```\n\n---\n\n## The New Tool\n\n### `ExecuteUpsertTool`\n**File:** `backend/pitboss/tools.py:223-273`\n\n**What it does:** Calls the PostgreSQL upsert procedure\n\n**Implementation:**\n```python\nasync def execute(self, jsonb_payload: Dict[str, Any], **kwargs):\n    payload_json = json.dumps(jsonb_payload)\n    async with self.db_pool.acquire() as conn:\n        result = await conn.fetchrow(\n            \"CALL upsert_pattern_factory_entities($1::jsonb, NULL::jsonb)\",\n            payload_json\n        )\n```\n\n**Registered in:** `ToolRegistry._register_default_tools()` (line 291)\n\n---\n\n## Critical Implementation Details\n\n### Flow Detection\n**File:** `backend/pitboss/supervisor.py:185`\n\n```python\n# Supervisor passes verb into message_body\nenv.messageBody[\"_verb\"] = verb_str  # \"RULE\" or \"CONTENT\"\n```\n\nAgents read this to detect which workflow they're in.\n\n### Procedure Call Syntax\n```sql\nCALL upsert_pattern_factory_entities($1::jsonb, NULL::jsonb)\n```\n\nWhere `$1` is the validated JSON payload:\n```json\n{\n  \"orgs\": [...],\n  \"guests\": [...],\n  \"posts\": [...],\n  \"patterns\": [...],\n  \"pattern_post_link\": [...],\n  \"pattern_org_link\": [...],\n  \"pattern_guest_link\": [...]\n}\n```\n\n### Workflow Route\n**File:** `backend/pitboss/workflow.py:108-113`\n\n```python\nmodel.verifyUpsert → (yes) → tool.executeSQL\n                  → (no)  → sendMessageToChat\n```\n\n---\n\n## Data Flow Through Message Body\n\n1. **agent_request_to_extract_entities**\n   - Stores: `message_body[\"extracted_entities\"] = {orgs, guests, posts, patterns, links}`\n   - Returns: User-friendly summary (NOT the JSON)\n\n2. **agent_verify_upsert**\n   - Reads: `message_body[\"extracted_entities\"]`\n   - Validates structure and integrity\n   - Returns: Validation result\n\n3. **agent_execute_sql**\n   - Reads: `message_body[\"_verb\"]` (CONTENT)\n   - Reads: `message_body[\"extracted_entities\"]`\n   - Calls: `ExecuteUpsertTool.execute(jsonb_payload=extracted_entities)`\n   - Stores: `message_body[\"upsert_status\"] = \"success\"`\n\n---\n\n## Testing the Flow\n\n```bash\n# In UI or WebSocket\nUser: \"extract https://newsletter.dannylieberman.com/p/...\"\n\n↓ model.Capo_content: [YES] (99%)\n↓ model.verifyRequest_content: [YES] (96%)\n↓ model.requestToExtractEntities: [YES] (96%)\n  Post: 'Dissent is an act of faith' (Sep 26, 2025)\n  Organizations: Medable\n  Guests: Pamela Tenaerts\n  Patterns: Boss is Stuck\n\n↓ model.verifyUpsert: [YES] (94%)\n  Payload validation passed: orgs=1 guests=1 posts=1 patterns=1\n\n↓ tool.executeSQL: [YES] (96%)\n  Content extraction and upsert complete: https://...\n```\n\n---\n\n## Files Changed\n\n| File | Change | Impact |\n|------|--------|--------|\n| `agents.py` | +verifyUpsert, modified executeSQL, updated extraction | ⭐ Core logic |\n| `tools.py` | +ExecuteUpsertTool | DB procedure call |\n| `supervisor.py` | Pass `_verb` | Flow detection |\n| `workflow.py` | None | Already correct |\n\n---\n\n## Debugging Tips\n\n**Agent not routing correctly?**\n- Check: `message_body[\"_verb\"]` is set in supervisor\n- Check: Workflow.py has correct edges\n\n**Validation failing?**\n- Check: All required arrays present (not None)\n- Check: Entity names are non-empty strings\n- Check: Link table names match entity names exactly\n\n**Upsert failing?**\n- Check: Database procedure exists: `upsert_pattern_factory_entities`\n- Check: JSONB payload is valid JSON\n- Check: Database logs for procedure errors\n\n**User seeing raw JSON?**\n- Extraction agent must return `decision=\"yes\"` (not `\"no\"`)\n- Check line 949-951 in agents.py\n\n---\n\n## Error Scenarios\n\n| Failure Point | Decision | Routes To | User Sees |\n|---------------|----------|-----------|----------|\n| Invalid URL | NO | sendMessageToChat | \"Invalid URL: ...\" |\n| HTTP error | NO | sendMessageToChat | \"HTTP 404 fetching https://...\" |\n| LLM failure | NO | sendMessageToChat | \"Entity extraction failed: ...\" |\n| Bad structure | NO | sendMessageToChat | \"Missing required array keys: ...\" |\n| Missing name | NO | sendMessageToChat | \"Post at index 0 missing name\" |\n| Orphan link | NO | sendMessageToChat | \"pattern_post_link references non-existent post ...\" |\n| Procedure error | NO | sendMessageToChat | \"Upsert procedure failed: ...\" |\n\n---\n\n## Success Path\n\nAll agents return `decision=\"yes\"` and data flows through:\n\n```\nURL → Extract → Verify → Execute → Database ✅\n                                  ↓\n                            sendMessageToChat\n                          (\"Upsert complete\")\n```\n"}