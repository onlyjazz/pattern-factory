CREATE OR REPLACE VIEW threat.vulnerability_exploitability AS
SELECT a.name AS asset_name,
       v.name AS vulnerability_name,
       t.name AS threat_name,
       t.probability AS threat_probability,
       at.damage AS pct_damage_to_asset,
       round((t.probability * at.damage)::numeric / 100.0)::integer AS exploitability
  FROM assets a
     JOIN asset_threat at ON a.id = at.asset_id AND a.model_id = at.model_id
     JOIN threats t ON at.threat_id = t.id AND t.model_id = at.model_id
     JOIN vulnerability_threat vt ON t.id = vt.threat_id AND t.model_id = vt.model_id
     JOIN vulnerabilities v ON vt.vulnerability_id = v.id AND v.model_id = vt.model_id
  WHERE t.model_id = (( SELECT active_models.model_id
                         FROM public.active_models
                        LIMIT 1))
  ORDER BY exploitability DESC;