# Clinical Trial Data Review - Project Context and Recent Improvements

## Project Overview
This is a clinical trial data review application with a SvelteKit frontend and FastAPI/Python backend that processes DSL rules to identify data anomalies in clinical trial datasets.

## Recent Improvements (August 31, 2024)

### Frontend Aesthetic Improvements

#### 1. Date Formatting
- Created `formatDate()` utility function in `/src/lib/index.ts`
- Formats dates as "MMM dd, YYYY" (e.g., "Aug 31, 2025")
- Applied to Cards, Rules, and Alerts pages for `date_created` and `date_amended` fields

#### 2. CodeMirror Integration for System Prompts
- Replaced plain text inputs with CodeMirror editors in Cards page
- Applied to both AddCard and EditCard modals
- Editor height set to 600px (3x original) for better multi-line editing
- Configured with Python syntax highlighting
- Preserves newlines and formatting when saving/displaying

#### 3. Newline Preservation in Tables
- Fixed issue where newlines in system prompts weren't displaying in tables
- Added `white-space: pre-wrap` CSS to preserve formatting
- Fixed card matching logic to not use prompt field (which could change)
- Cards now refresh from database after add/update to ensure data consistency

#### 4. Sidebar Simplification
- Removed Data Dictionary from left sidebar (accessible via Studies > Actions)
- Freed up space for future features

### Backend Message Flow Improvements

#### 1. Fixed WebSocket Message Handling (server.py)
- Removed hardcoded rule: "Find all patients with albumin levels above 100"
- Now properly extracts from incoming messages:
  - `rule_code`: The actual rule logic to execute
  - `system_prompt`: Custom prompt for the AI
  - `protocol_id`: Which protocol/study to run against
  - `rule_id`: Identifier for the rule (e.g., "ECOG_MISSING", "ALT_HIGH")
- Added support for DSL workflow execution via `dsl` parameter

#### 2. Improved Response Format (pitboss.py)
- Changed from ASCII table output to summary messages
- New format: `"{rule_id} - {count} records flagged for {message} Severity: {severity}"`
- Example: `"ALT_HIGH - 325 records flagged for 'ALT > 100' Severity: Major"`
- Still preserves SQL query and table name for debugging

## Key Files Modified

### Frontend
- `/src/lib/index.ts` - Date formatting utilities
- `/src/routes/cards/+page.svelte` - Cards list with date formatting
- `/src/lib/ModalForms/EditCard.svelte` - CodeMirror for editing
- `/src/lib/ModalForms/AddCard.svelte` - CodeMirror for adding
- `/src/routes/actions/rules/+page.svelte` - Date formatting
- `/src/routes/actions/alerts/+page.svelte` - Date formatting
- `/src/lib/Sidebar.svelte` - Removed Data Dictionary

### Backend
- `/services/server.py` - Fixed message parsing, added workflow support
- `/services/pitboss.py` - Changed output format to summary messages

## Running the Application

### Frontend
```bash
cd /Users/dl/code/clinical-trial-data-review
npm run dev
# Runs on http://localhost:5173
```

### Backend
```bash
cd /Users/dl/code/clinical-trial-data-review/services
python server.py
# Or from project root:
python services/server.py
# WebSocket server runs on port 8002
# API server should be running on port 8000
```

### Environment Variables
- `DATABASE_LOCATION` - Path to DuckDB database file

## Testing Rule Execution

In the AI Chat, you can execute rules in multiple ways:

### Command Formats
- `run ECOG_MISSING` - Executes specific rule by ID from the DSL
- `run ALT_HIGH` - Executes another specific rule from the DSL
- `run SELECT * FROM adlb WHERE alt > 100` - Executes direct SQL
- `run Find patients with missing ECOG values` - Natural language converted to SQL
- `run` - Executes entire workflow with all rules

### How It Works
1. **Rule matching**: First checks if the text after `run` matches a `rule_code` in the DSL
2. **Direct execution**: If no match, treats the text as either:
   - Direct SQL (if it starts with SELECT/INSERT/UPDATE/DELETE/CREATE)
   - Natural language to be converted to SQL by GPT-4
3. **System prompt**: Automatically uses the system prompt from the cards table

### System Prompt Configuration
The system prompt that guides SQL generation is fetched from the `cards` table:
- Looks for: `protocol_id = {current_protocol}` AND `agent = "model_rule_agent"`
- Uses the `prompt` field from that card
- Fallback: `"You are an expert SQL translator. Always output only valid SQL."`

**Important**: The multi-line system prompts created in the Cards page (using CodeMirror) directly control how the Language Agent (GPT-4) interprets and converts rules to SQL. This allows customization of:
- Database schema context
- SQL generation patterns
- Handling of NULL values and JOINs
- Clinical trial specific logic

### Example System Prompt (in Cards)
```
You are an expert SQL translator for clinical trial data.
Database tables include:
- adlb: lab results (columns: subjid, alt, ast, bilirubin...)
- adae: adverse events (columns: subjid, aeterm, aesev...)
- addm: demographics (columns: subjid, age, sex, race...)
Always use proper JOIN conditions and handle NULL values appropriately.
Output only valid DuckDB SQL.
```

### Expected Output Format
```
ECOG_MISSING - 42 records flagged for "Check for missing ECOG values" Severity: Major
ALT_HIGH - 325 records flagged for "ALT > 100" Severity: Major
```

## Architecture Notes

### Message Flow
1. User types command in AI Chat (frontend)
2. Frontend extracts rule from DSL and sends via WebSocket
3. Backend Pitboss orchestrates three agents:
   - Language Agent: Converts rule logic to SQL (via GPT-4)
   - Tool Agent: Executes SQL against DuckDB
   - Callback Agent: Sends results back to frontend
4. Results displayed in AI Chat as summary messages

### Data Model
- `cards` table: Stores system prompts for different agents
- `rules` table: Stores rule definitions and execution history
- `alerts` table: Stores flagged records and summary counts
- `protocols` table: Study/protocol metadata
- Result tables: Materialized as `{protocol_id}_{rule_id}`

## Future Enhancements Discussed
- Query data dictionary from AI chat
- Additional sidebar features (space now available)
- Workflow execution with multiple rules
- Severity extraction from DSL rules
